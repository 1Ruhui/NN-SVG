<!doctype html>
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <!-- <link rel="shortcut icon" href="favicon.ico" /> -->

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">

    <style type="text/css">
        svg {
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
            position: absolute;
        }

        .nn-picker {
            width: 410px;
            height: 500px;
            margin: 30px;
            z-index: 1000;
        }

        .tab-content {
            padding: 20px;
        }

        .entry {
            width: 160px;
        }
    </style>

    <title>NN SVG</title>

</head>
<body>

    <!-- <div id="graph-container"></div> -->

    <div class="container-fluid">

        <div class="row">
            <div class="nn-picker">
                <div class="card">
                    <div class="card-header">
                        <h1>NN-SVG</h1>

                        <nav>
                            <div class="nav nav-tabs card-header-tabs" role="tablist">
                                <a class="nav-item nav-link active" data-toggle="tab" href="#FCNN" role="tab">FCNN style</a>
                                <a class="nav-item nav-link disabled" data-toggle="tab" href="#LeNet" role="tab">LeNet style</a>
                                <a class="nav-item nav-link disabled" data-toggle="tab" href="#AlexNet" role="tab">AlexNet style</a>
                            </div>
                        </nav>

                    </div>
                    <div class="tab-content">
                        <div class="tab-pane fade show active" id="FCNN" role="tabpanel">

                            <h4>Style:</h4>

                            <!-- Edge Width -->
                            <hr>
                            <div>
                                <input type="checkbox" id="edgeWidthProportional" name="edgeWidthProportional" value="edgeWidthProportional" onchange="edgeWidthProportional=this.value;restart()">
                                <label for="edgeWidthProportional">Edge width proportional to edge weights</label>
                            </div>
                            <div>
                                <label for="edgeWidth">Edge Width</label>
                                <input type="range" id="edgeWidth" name="" min="0" max="10" step="0.1" value="3" onchange="edgeWidth=this.value;restart();">
                            </div>

                            <!-- Edge Opacity -->
                            <hr>
                            <div>
                                <input type="checkbox" id="edgeOpacityProportional" name="edgeOpacityProportional" value="edgeOpacityProportional" onchange="edgeOpacityProportional=this.value;restart()">
                                <label for="edgeOpacityProportional">Edge opacity proportional to edge weights</label>
                            </div>
                            <div>
                                <label for="edgeOpacity">Edge Opacity</label>
                                <input type="range" id="edgeOpacity" name="" min="0" max="1" step="0.01" value="1" onchange="edgeOpacity=this.value;restart();">
                            </div>

                            <!-- Edge Color -->
                            <hr>
                            <div>
                                <input type="checkbox" id="edgeColorProportional" name="edgeColorProportional" value="edgeColorProportional" onchange="edgeColorProportional=this.value;restart()">
                                <label for="edgeColorProportional">Edge color proportional to edge weights</label>
                            </div>
                            <div>
                                <input type="color" value="#0000ff" id="negativeEdgeColor" onchange="negativeEdgeColor=this.value;restart()">
                                <label for="negativeEdgeColor">Negative Edge Weight Color</label>
                            </div>
                            <div>
                                <input type="color" value="#ff0000" id="positiveEdgeColor" onchange="positiveEdgeColor=this.value;restart()">
                                <label for="positiveEdgeColor">Positive Edge Weight Color</label>
                            </div>

                            <!-- Node Properties -->
                            <hr>
                            <div>
                                <label for="nodeDiameter">Node Diameter</label>
                                <input type="range" id="nodeDiameter" name="" min="10" max="100" step="1" value="20" onchange="node_diameter=this.value;restart();">
                            </div>
                            <div>
                                <input type="color" value="#aaaaaa" id="nodeColor" onchange="nodeColor=this.value;restart()">
                                <label for="nodeColor">Node Color</label>
                            </div>
                            <div>
                                <input type="color" value="#888888" id="nodeBorderColor" onchange="nodeBorderColor=this.value;restart()">
                                <label for="nodeBorderColor">Node Border Color</label>
                            </div>

                            <!-- maybe add spacing between nodes -->
                            <!-- maybe add direction the NN should point -->
                            <!-- maybe add arrows pointing into input, out of output -->

                            <hr>
                            <h4>Architecture:</h4>

                            <hr>
                            <div id="architecture">

                                <div class="entry input-group mb-2 mr-sm-2">
                                    <button class="btn btn-secondary btn-remove input-group-prepend" type="button">
                                        <span class="fa fa-minus"></span>
                                    </button>
                                    <input class="form-control" name="fields[]" type="number" step="1" value="8" />
                                </div>
                                <div class="entry input-group mb-2 mr-sm-2">
                                    <button class="btn btn-secondary btn-remove input-group-prepend" type="button">
                                        <span class="fa fa-minus"></span>
                                    </button>
                                    <input class="form-control" name="fields[]" type="number" step="1" value="12" />
                                </div>
                                <div class="entry input-group mb-2 mr-sm-2">
                                    <button class="btn btn-secondary btn-remove input-group-prepend" type="button">
                                        <span class="fa fa-minus"></span>
                                    </button>
                                    <input class="form-control" name="fields[]" type="number" step="1" value="8" />
                                </div>
                                <div class="entry input-group mb-2 mr-sm-2">
                                    <button class="btn btn-primary btn-add input-group-prepend" type="button">
                                        <span class="fa fa-plus"></span>
                                    </button>
                                    <input class="form-control" name="fields[]" type="number" step="1"/>
                                </div>


                                <!-- <button type="button" class="btn btn-sm btn-secondary">Add a layer</button> -->
                            </div>

                            <hr>
                            <button type="button" class="btn btn-sm btn-secondary">New Random Weights</button>

                            <hr>
                            <div>
                                <a id="saveButton" href="javascript:(function () { var e = document.createElement('script'); if (window.location.protocol === 'https:') { e.setAttribute('src', 'https://rawgit.com/NYTimes/svg-crowbar/gh-pages/svg-crowbar.js'); } else { e.setAttribute('src', 'http://nytimes.github.com/svg-crowbar/svg-crowbar.js'); } e.setAttribute('class', 'svg-crowbar'); document.body.appendChild(e); })();">
                                    <big>â‡©</big> Download SVG (doesn't work yet)
                                </a>
                            </div>

                        </div>
                        <div class="tab-pane fade" id="LeNet" role="tabpanel">
                            <h4>Style:</h4>

                            <h4>Architecture:</h4>


                        </div>
                        <div class="tab-pane fade" id="AlexNet" role="tabpanel">
                            <h4>Style:</h4>

                            <h4>Architecture:</h4>

                        </div>
                </div>
            </div>
        </div>
    </div>



    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>

    <script type="text/javascript" src="https://d3js.org/d3.v5.min.js"></script>

    <script type="text/javascript">

/////////////////////////////////////////////////////////////////////////////
                    ///////    Helper Functions    ///////
/////////////////////////////////////////////////////////////////////////////

let range = n => [...Array(n).keys()];


let nWise = (n, array) => {
  iterators = Array(n).fill().map(() => array[Symbol.iterator]());
  iterators.forEach((it, index) => Array(index).fill().forEach(() => it.next()));
  return Array(array.length - n + 1).fill().map(() => (iterators.map(it => it.next().value)));
};

let pairWise = (array) => nWise(2, array);

function flatten(array) {
  return array.reduce(function (flat, toFlatten) {
    return flat.concat(Array.isArray(toFlatten) ? flatten(toFlatten) : toFlatten);
  }, []);
}

function isNumber(n) {
    return !isNaN(parseFloat(n)) && isFinite(n);
}

/////////////////////////////////////////////////////////////////////////////
                      ///////    Variables    ///////
/////////////////////////////////////////////////////////////////////////////

var w = window.innerWidth;
var h = window.innerHeight;

var svg = d3.select("body").append("svg");
var g = svg.append("g");
// svg.style("cursor", "move");

var edgeWidthProportional = false;
var edgeWidth = 1.0;
var weightedEdgeWidth = d3.scaleLinear().domain([-1, 1]).range([, ]);

var edgeOpacityProportional = false;
var edgeOpacity = 1.0
var weightedEdgeOpacity = d3.scaleLinear().domain([-1, 1]).range([, ]);

var edgeColorProportional = false;
var defaultEdgeColor = "#555";
var negativeEdgeColor = "#0000ff";
var positiveEdgeColor = "#ff0000";
var weightedEdgeColor = d3.scaleLinear().domain([-1, 1]).range([negativeEdgeColor, positiveEdgeColor]);

var nodeDiameter = 20;
var nodeColor = "#aaaaaa";
var nodeBorderColor = "#888888";

var architecture = [8, 12, 8];
var graph = {};

/////////////////////////////////////////////////////////////////////////////
                 ///////    Select Architecture    ///////
/////////////////////////////////////////////////////////////////////////////


$(document).on('click', '.btn-add', function(e) {
    e.preventDefault();

    var controlForm = $('#architecture');
    var currentEntry = $(this).parents('.entry:first');
    var newEntry = $(currentEntry.clone()).appendTo(controlForm);

    newEntry.find('input').val('');
    controlForm.find('.entry:not(:last) .btn-add')
        .removeClass('btn-add').addClass('btn-remove')
        .removeClass('btn-primary').addClass('btn-secondary')
        .html('<span class="fa fa-minus"></span>');

    // change graph.nodes and graph.links

}).on('click', '.btn-remove', function(e) {
    e.preventDefault();

    $(this).parents('.entry:first').remove();

    // change graph.nodes and graph.links

    return false;
});





/////////////////////////////////////////////////////////////////////////////
                      ///////    Draw Graph    ///////
/////////////////////////////////////////////////////////////////////////////

architecture = $('#architecture').find('input').map((i,el) => $(el).val()).get().filter(input => $.isNumeric(input)).map(s => parseInt(s));

graph.nodes = architecture.map((layer, layer_index) => range(layer).map(node_index => {return {'id':layer_index+'_'+node_index,'layer':layer_index}}));
graph.links = pairWise(graph.nodes).map((nodes) => nodes[0].map(left => nodes[1].map(right => {return {'source':left.id,'target':right.id,'weight':1}})));
graph.nodes = flatten(graph.nodes);
graph.links = flatten(graph.links);

var link = g.selectAll(".link")
            .data(graph.links)
            .enter().append("line")
            .attr("class", "link")
            .style("stroke-width", function(d) {
                if (edgeWidthProportional) { return weightedEdgeWidth(abs(d.weight)); }
                else { return edgeWidth; }
            })
            .style("stroke", function(d) {
                if (edgeColorProportional) { return weightedEdgeColor(d.weight); }
                else { return defaultEdgeColor; }
            })


var node = g.selectAll(".node")
            .data(graph.nodes)
            .enter().append("path")
            .attr("class", "node")
            .attr("id", function(d) { return d.id; })
            // .attr("d",d => display_type(d.type))
            .style("fill", nodeColor)
            .style("stroke", nodeBorderColor)
            .style("stroke-width", 1)


function restart() {

    architecture = $('#architecture').find('input').map((i,el) => $(el).val()).get().filter(input => $.isNumeric(input)).map(s => parseInt(s));

    graph.nodes = architecture.map((layer, layer_index) => range(layer).map(node_index => {return {'id':layer_index+'_'+node_index,'layer':layer_index}}));
    graph.links = pairWise(graph.nodes).map((nodes) => nodes[0].map(left => nodes[1].map(right => {return {'source':left.id,'target':right.id,'weight':1}})));
    graph.nodes = flatten(graph.nodes);
    graph.links = flatten(graph.links);

    nodes = graph.nodes;
    node = node.data(nodes);
    node.exit().remove();
    node = node.enter()
               .append("path")
               .attr("class", "node")
               .attr("id", function(d) { return d.id; })
               // .attr("d",d => display_type(d.type))
               .style("fill", nodeColor)
               .style("stroke", nodeBorderColor)
               .style("stroke-width", 1)


    links = graph.links;
    link = link.data(links);
    link.exit().remove();
    link = link.enter()
               .insert("line", ".node") // insert before "node" so that nodes show up on top
               .attr("class", "link")
               .style("stroke-width", function(d) {
                   if (edgeWidthProportional) { return weightedEdgeWidth(abs(d.weight)); }
                   else { return edgeWidth; }
               })
               .style("stroke", function(d) {
                   if (edgeColorProportional) { return weightedEdgeColor(d.weight); }
                   else { return defaultEdgeColor; }
               })
               .merge(link);


}

restart();


/////////////////////////////////////////////////////////////////////////////
                      ///////    Zoom    ///////
/////////////////////////////////////////////////////////////////////////////

svg.call(d3.zoom()
           .scaleExtent([1 / 2, 8])
           .on("zoom", zoomed));

function zoomed() { g.attr("transform", d3.event.transform); }


/////////////////////////////////////////////////////////////////////////////
                      ///////    Resize    ///////
/////////////////////////////////////////////////////////////////////////////

function resize() {
    w = window.innerWidth;
    h = window.innerHeight;
    svg.attr("width", w).attr("height", h);
}

d3.select(window).on("resize", resize)

resize();


/////////////////////////////////////////////////////////////////////////////
                ///////    Additional Features    ///////
/////////////////////////////////////////////////////////////////////////////


    </script>

</body>

</html>
